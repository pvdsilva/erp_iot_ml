{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-cash-register"></i> Vendas</h2>
    <a href="{{ url_for('nova_venda') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nova Venda
    </a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="card">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">Lista de Vendas</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Valor Total</th>
                        <th>Forma de Pagamento</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for venda in vendas %}
                    <tr>
                        <td><strong>#{{ venda.id }}</strong></td>
                        <td>{{ venda.data_venda.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>{{ venda.nome_cliente or 'Cliente não identificado' }}</td>
                        <td>R$ {{ "%.2f"|format(venda.valor_total) }}</td>
                        <td>
                            {% if venda.forma_pagamento == 'dinheiro' %}
                                <span class="badge bg-success">Dinheiro</span>
                            {% elif venda.forma_pagamento == 'cartao_credito' %}
                                <span class="badge bg-primary">Cartão de Crédito</span>
                            {% elif venda.forma_pagamento == 'cartao_debito' %}
                                <span class="badge bg-info">Cartão de Débito</span>
                            {% elif venda.forma_pagamento == 'pix' %}
                                <span class="badge bg-warning">PIX</span>
                            {% elif venda.forma_pagamento == 'transferencia' %}
                                <span class="badge bg-secondary">Transferência</span>
                            {% else %}
                                <span class="badge bg-dark">{{ venda.forma_pagamento|title }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ 'success' if venda.status == 'concluida' else 'danger' if venda.status == 'cancelada' else 'warning' }}">
                                {% if venda.status == 'concluida' %}
                                    CONCLUÍDA
                                {% elif venda.status == 'cancelada' %}
                                    CANCELADA
                                {% else %}
                                    {{ venda.status|upper }}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('detalhes_venda', id=venda.id) }}" class="btn btn-info" title="Detalhes">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('imprimir_venda', id=venda.id) }}" target="_blank" class="btn btn-warning" title="Imprimir">
                                    <i class="fas fa-print"></i>
                                </a>
                                {% if venda.status != 'cancelada' %}
                                <button onclick="cancelarVenda({{ venda.id }})" class="btn btn-danger" title="Cancelar Venda">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <p>Nenhuma venda encontrada.</p>
                            <a href="{{ url_for('nova_venda') }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Realizar Primeira Venda
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function cancelarVenda(id) {
    if (confirm('Tem certeza que deseja cancelar esta venda?\n\nOs produtos serão repostos no estoque automaticamente.')) {
        
        // Mostrar loading
        const btn = event.target;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        fetch(`/vendas/${id}/cancelar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Erro ao cancelar venda');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Venda cancelada com sucesso! Estoque reposto.');
                location.reload();
            } else {
                throw new Error(data.error || 'Erro ao cancelar venda');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao cancelar venda: ' + error.message);
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
}

// Prevenir envio duplo do formulário
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            }
        });
    });
});
</script>

<style>
.table th {
    border-top: none;
    font-weight: 600;
}

.btn-group .btn {
    border-radius: 0.25rem;
    margin-right: 0.25rem;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

.badge {
    font-size: 0.75em;
}

.table-responsive {
    border-radius: 0.375rem;
}
</style>
{% endblock %}
