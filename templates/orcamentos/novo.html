{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="fas fa-file-invoice-dollar"></i> Novo Orçamento</h2>
        <hr>
    </div>
</div>

<form id="formOrcamento" method="POST">
    <div class="row">
        <!-- Dados do Orçamento -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Dados do Orçamento</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="id_cliente" class="form-label">Cliente</label>
                        <select class="form-select" id="id_cliente" name="id_cliente">
                            <option value="">Selecione um cliente</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
                        <select class="form-select" id="forma_pagamento" name="forma_pagamento" required>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="cartao_credito">Cartão de Crédito</option>
                            <option value="cartao_debito">Cartão de Débito</option>
                            <option value="pix">PIX</option>
                            <option value="transferencia">Transferência Bancária</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="validade" class="form-label">Validade (dias)</label>
                        <input type="number" class="form-control" id="validade" name="validade" value="7" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="condicoes_pagamento" class="form-label">Condições de Pagamento</label>
                        <textarea class="form-control" id="condicoes_pagamento" name="condicoes_pagamento" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seleção de Produtos -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Adicionar Produtos</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="produto_select" class="form-label">Selecionar Produto</label>
                        <select class="form-select" id="produto_select">
                            <option value="">Selecione um produto</option>
                            {% for produto in produtos %}
                            <option value="{{ produto.id }}" data-preco="{{ produto.preco_venda }}" data-estoque="{{ produto.quantidade }}">
                                {{ produto.nome }} - R$ {{ "%.2f"|format(produto.preco_venda) }} (Estoque: {{ produto.quantidade }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quantidade" class="form-label">Quantidade</label>
                        <input type="number" class="form-control" id="quantidade" min="0.01" value="1" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="preco_unitario" class="form-label">Preço Unitário (R$)</label>
                        <input type="number" class="form-control" id="preco_unitario" min="0.01" step="0.01" value="0">
                    </div>
                    <button type="button" class="btn btn-primary w-100" id="btnAdicionarItem">
                        <i class="fas fa-cart-plus"></i> Adicionar ao Carrinho
                    </button>
                </div>
            </div>
        </div>

        <!-- Carrinho e Totais -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">Carrinho de Itens</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Qtd</th>
                                    <th>Preço</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="carrinhoItens">
                                <!-- Itens serão adicionados aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">R$ 0,00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Desconto:</span>
                            <input type="number" class="form-control form-control-sm" id="desconto" name="desconto" value="0" min="0" step="0.01" style="width: 100px;">
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Total:</strong>
                            <strong id="total">R$ 0,00</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('orcamentos') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
                <div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Salvar Orçamento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Campos hidden para armazenar os dados -->
    <input type="hidden" name="itens" id="itensJson" value="[]">
    <input type="hidden" name="valor_total" id="valorTotal" value="0">
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const produtoSelect = document.getElementById('produto_select');
    const quantidadeInput = document.getElementById('quantidade');
    const precoUnitarioInput = document.getElementById('preco_unitario');
    const btnAdicionarItem = document.getElementById('btnAdicionarItem');
    const carrinhoItens = document.getElementById('carrinhoItens');
    const subtotalElement = document.getElementById('subtotal');
    const descontoInput = document.getElementById('desconto');
    const totalElement = document.getElementById('total');
    const itensJson = document.getElementById('itensJson');
    const valorTotal = document.getElementById('valorTotal');
    const formOrcamento = document.getElementById('formOrcamento');

    let itens = [];

    // Atualizar preço quando selecionar produto
    produtoSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            precoUnitarioInput.value = parseFloat(selectedOption.dataset.preco).toFixed(2);
        } else {
            precoUnitarioInput.value = '0.00';
        }
    });

    // Calcular totais
    function calcularTotais() {
        let subtotal = 0;
        itens.forEach(item => {
            subtotal += parseFloat(item.quantidade) * parseFloat(item.preco_unitario);
        });
        
        const desconto = parseFloat(descontoInput.value) || 0;
        const total = Math.max(0, subtotal - desconto); // Garantir que não fique negativo
        
        subtotalElement.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
        totalElement.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        valorTotal.value = total;
        
        // Atualizar campo hidden com itens em JSON
        itensJson.value = JSON.stringify(itens);
    }

    // Renderizar carrinho
    function renderizarCarrinho() {
        carrinhoItens.innerHTML = '';
        itens.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-truncate" style="max-width: 100px;" title="${item.nome}">${item.nome}</td>
                <td>${parseFloat(item.quantidade).toFixed(2)}</td>
                <td>R$ ${parseFloat(item.preco_unitario).toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removerItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            carrinhoItens.appendChild(tr);
        });
        calcularTotais();
    }

    // Adicionar item ao carrinho
    function adicionarItem() {
        const produtoId = produtoSelect.value;
        const produtoTexto = produtoSelect.options[produtoSelect.selectedIndex].text;
        const preco = parseFloat(precoUnitarioInput.value);
        const quantidade = parseFloat(quantidadeInput.value);
        const estoque = parseInt(produtoSelect.selectedOptions[0].dataset.estoque);

        if (!produtoId) {
            alert('Selecione um produto!');
            return;
        }

        if (isNaN(quantidade) || quantidade <= 0) {
            alert('Quantidade deve ser um número maior que zero!');
            return;
        }

        if (isNaN(preco) || preco <= 0) {
            alert('Preço deve ser um número maior que zero!');
            return;
        }

        if (quantidade > estoque) {
            alert(`Quantidade indisponível! Estoque: ${estoque}`);
            return;
        }

        // Adicionar ao array de itens
        itens.push({
            id_produto: produtoId,
            nome: produtoTexto.split(' - R$ ')[0],
            preco_unitario: preco,
            quantidade: quantidade
        });

        renderizarCarrinho();

        // Limpar campos
        produtoSelect.value = '';
        quantidadeInput.value = '1';
        precoUnitarioInput.value = '0.00';
    }

    // Remover item do carrinho
    window.removerItem = function(index) {
        itens.splice(index, 1);
        renderizarCarrinho();
    }

    // Event listeners
    btnAdicionarItem.addEventListener('click', adicionarItem);
    descontoInput.addEventListener('input', calcularTotais);

    // Validar formulário antes de enviar
    formOrcamento.addEventListener('submit', function(e) {
        if (itens.length === 0) {
            e.preventDefault();
            alert('Adicione pelo menos um item ao orçamento!');
            return;
        }

        // Garantir que o valor total seja maior que zero
        const totalFinal = parseFloat(valorTotal.value);
        if (isNaN(totalFinal) || totalFinal <= 0) {
            e.preventDefault();
            alert('O valor total do orçamento deve ser maior que zero!');
            return;
        }
    });

    // Inicializar valores
    precoUnitarioInput.value = '0.00';
    quantidadeInput.value = '1';
    calcularTotais();
});
</script>
{% endblock %}
